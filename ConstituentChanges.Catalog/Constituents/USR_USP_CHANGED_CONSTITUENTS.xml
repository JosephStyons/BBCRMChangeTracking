<SQLStoredProcedureSpec
  xmlns="bb_appfx_sqlstoredprocedure"
  xmlns:c="bb_appfx_commontypes" 
  ID="60fd6aed-fb9e-472f-922c-d4c53828e7f2"
  Name="USR_USP_CHANGED_CONSTITUENTS"
  Description="Given a time, return all constituents with an important change since that time."
  Author="Joseph Styons"
  SPName="USR_USP_CHANGED_CONSTITUENTS"
  >
	<CreateProcedureSQL>
		<![CDATA[
create procedure dbo.USR_USP_CHANGED_CONSTITUENTS
(
  @SINCE datetime
)
as
begin
  select distinct con.id, 'New'
  from
    constituent con
    left join address a on a.constituentid = con.id
  where con.DATEADDED > @since
     or a.DATEADDED > @since
  union
  --give me records that were *updated* since that time
  select distinct con.id, 'Changed'
  from
    constituent con
    left join address a on a.constituentid = con.id
  where con.DATECHANGED > @since
     or a.DATECHANGED > @since
  union
  --give me records that were *deleted* since that time
  select distinct con.id, 'Deleted'
  from
    CONSTITUENTAUDIT ca
    left join constituent con on con.id = ca.AUDITRECORDID
    left join ADDRESSAUDIT aa on aa.CONSTITUENTID = ca.AUDITRECORDID
  where (ca.AUDITDATE > @since or aa.AUDITDATE > @since)
    and (ca.AUDITTYPECODE = 2 or aa.AUDITTYPECODE = 2)--"2" == "BEFORE DELETE"
end
		]]>
	</CreateProcedureSQL>
</SQLStoredProcedureSpec>
